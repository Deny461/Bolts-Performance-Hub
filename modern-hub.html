<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boston Bolts • Performance Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bolts-blue: #1e3a8a;
      --bolts-green: #22c55e;
      --bolts-dark: #0f172a;
      --bolts-card: #111827;
    }
    html,body{ font-family: Inter, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body{ background: linear-gradient(180deg, var(--bolts-dark) 0%, #111827 100%); color: #e5e7eb; }
    .card{ background: var(--bolts-card); border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    .chip{ background: var(--bolts-green); color:#052e16; font-weight:800; }
    .pill{ border: 1px solid rgba(255,255,255,0.12); }
  </style>
</head>
<body>
  <div class="max-w-screen-2xl mx-auto px-5 py-6">
    <!-- Login overlay -->
    <div id="loginOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
      <div class="w-full max-w-sm card rounded-2xl p-6">
        <div class="text-xl font-extrabold mb-1">Coach Login</div>
        <div class="text-white/60 text-sm mb-4">Enter your credentials</div>
        <div class="space-y-3">
          <div>
            <div class="text-white/70 text-xs mb-1">Username</div>
            <input id="loginUser" class="w-full bg-white/5 border border-white/10 rounded-md p-2 outline-none" placeholder="e.g., denis" />
          </div>
          <div>
            <div class="text-white/70 text-xs mb-1">Password</div>
            <input id="loginPass" type="password" class="w-full bg-white/5 border border-white/10 rounded-md p-2 outline-none" placeholder="••••••" />
          </div>
          <div id="loginError" class="text-red-400 text-xs h-4"></div>
          <button id="loginBtn" class="w-full bg-[var(--bolts-green)] text-green-950 font-bold py-2 rounded-md">Sign in</button>
        </div>
      </div>
    </div>
    <!-- Header -->
    <header class="rounded-2xl p-4 md:p-5 bg-gradient-to-r from-[var(--bolts-blue)] to-blue-800 shadow-2xl flex items-center justify-between">
      <div class="flex items-center gap-3 md:gap-4">
        <img src="BostonBoltsLogo.png" class="w-12 h-12 md:w-14 md:h-14" alt="Boston Bolts" />
        <div>
          <div class="text-white font-extrabold text-xl md:text-2xl tracking-tight">Boston Bolts • Performance Hub</div>
          <div class="text-emerald-200 text-xs md:text-sm opacity-90">Modern analytics for coaches</div>
        </div>
      </div>
      <div class="chip text-xs md:text-sm px-3 py-1 rounded-full">LIVE</div>
    </header>

    <!-- Top Nav (static for now) -->
    <nav class="mt-5 flex flex-wrap gap-2">
      <a class="pill rounded-full px-3 py-1 text-sm hover:bg-white/5" href="#gauges">Gauges</a>
      <a class="pill rounded-full px-3 py-1 text-sm hover:bg-white/5" href="#acwr">ACWR</a>
      <a class="pill rounded-full px-3 py-1 text-sm hover:bg-white/5" href="#radars">Physical Radar Charts</a>
      <a class="pill rounded-full px-3 py-1 text-sm hover:bg-white/5" href="#testing">Testing Data</a>
    </nav>

    <!-- Hero / Quick actions -->
    <section class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card rounded-xl p-4 md:col-span-2">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg md:text-xl font-bold">Team Overview</h2>
            <p class="text-sm text-white/70">Select a team and player to explore dashboards</p>
          </div>
          <img src="MLSNextLogo.png" class="h-10 opacity-80" alt="MLS Next" />
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="bg-white/5 rounded-lg p-3 border border-white/10">
            <div class="text-xs text-white/70">Team</div>
            <select id="teamSelect" class="w-full mt-1 bg-transparent outline-none"></select>
          </div>
          <div class="bg-white/5 rounded-lg p-3 border border-white/10">
            <div class="text-xs text-white/70">Player</div>
            <select id="playerSelect" class="w-full mt-1 bg-transparent outline-none"></select>
          </div>
          <div class="bg-white/5 rounded-lg p-3 border border-white/10">
            <div class="text-xs text-white/70">Status</div>
            <div id="statusText" class="text-sm text-emerald-300">Ready</div>
          </div>
        </div>
      </div>
      <div class="card rounded-xl p-4">
        <h3 class="text-lg font-bold">Jump to</h3>
        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
          <a href="#gauges" class="bg-white/5 hover:bg-white/10 rounded-lg p-3 border border-white/10">Gauges</a>
          <a href="#acwr" class="bg-white/5 hover:bg-white/10 rounded-lg p-3 border border-white/10">ACWR</a>
          <a href="#radars" class="bg-white/5 hover:bg-white/10 rounded-lg p-3 border border-white/10">Physical Radars</a>
          <a href="#testing" class="bg-white/5 hover:bg-white/10 rounded-lg p-3 border border-white/10">Testing Data</a>
        </div>
      </div>
    </section>

    <!-- Sections (static placeholders) -->
    <section id="gauges" class="mt-8">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-extrabold">Player Gauges</h2>
        <span class="text-xs text-white/60">Excel is master data • API enriched</span>
      </div>
      <div id="playerSummary" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </section>

    <section id="acwr" class="mt-10">
      <h2 class="text-xl font-extrabold">ACWR</h2>
      <div class="mt-4 card rounded-xl p-5 h-48 border border-white/10"></div>
    </section>

    <section id="radars" class="mt-10">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-extrabold">Physical Radar Charts</h2>
        <span class="text-xs text-white/60">Percentiles vs Team / Position</span>
      </div>
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card rounded-xl p-5 border border-white/10"><div class="text-sm text-white/70 mb-2">Testing-based • Player vs Team (percentiles)</div><canvas id="radarTeam"></canvas></div>
        <div class="card rounded-xl p-5 border border-white/10"><div class="text-sm text-white/70 mb-2">Testing-based • Player vs Position (percentiles)</div><canvas id="radarPosition"></canvas></div>
        <div class="card rounded-xl p-5 border border-white/10"><div class="text-sm text-white/70 mb-2">(Reserved) Match • Player only</div><canvas id="radarMatch"></canvas></div>
        <div class="card rounded-xl p-5 border border-white/10"><div class="text-sm text-white/70 mb-2">(Reserved) Training • Player vs Position</div><canvas id="radarTraining"></canvas></div>
      </div>
    </section>

    <section id="testing" class="mt-10 mb-12">
      <h2 class="text-xl font-extrabold">Testing Data</h2>
      <div id="testingData" class="mt-4 card rounded-xl p-5 border border-white/10"></div>
    </section>

    <footer class="mt-6 text-center text-xs text-white/50">© Boston Bolts • Performance Hub</footer>
  </div>

  <script>
    const API = 'http://127.0.0.1:8800';
    const teamSelect = document.getElementById('teamSelect');
    const playerSelect = document.getElementById('playerSelect');
    const statusText = document.getElementById('statusText');
    const playerSummary = document.getElementById('playerSummary');
    const testingData = document.getElementById('testingData');
    const loginOverlay = document.getElementById('loginOverlay');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    let session = JSON.parse(localStorage.getItem('bolts_session')||'null');
    let chartTeam, chartPosition, chartMatch, chartTraining;

    function setStatus(msg, ok=true){
      statusText.textContent = msg;
      statusText.className = ok ? 'text-sm text-emerald-300' : 'text-sm text-red-300';
    }

    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    async function postJSON(url, body){
      const r = await fetch(url, {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)});
      if(!r.ok) throw new Error(`${r.status}`);
      return r.json();
    }

    function renderSummaryCard(title, value){
      return `
        <div class="card rounded-xl p-5">
          <div class="text-white/70 text-sm">${title}</div>
          <div class="mt-2 text-2xl font-extrabold">${value ?? '-'}</div>
        </div>
      `;
    }

    function renderTestingTable(obj){
      if(!obj){ return '<div class="text-white/60">No testing data found.</div>'; }
      const entries = Object.entries(obj).filter(([k,v])=> k && v !== null && v !== '' );
      return `
        <div class="overflow-auto">
          <table class="w-full text-sm">
            ${entries.map(([k,v])=>`<tr class="border-b border-white/10"><td class="py-1 pr-3 text-white/60">${k}</td><td class="py-1">${v}</td></tr>`).join('')}
          </table>
        </div>
      `;
    }

    async function onTeamChange(){
      const team = teamSelect.value;
      playerSelect.innerHTML = '';
      setStatus('Loading players…');
      try{
        const players = await fetchJSON(`${API}/teams/${encodeURIComponent(team)}/players`);
        players.forEach(p=>{
          const opt = document.createElement('option');
          opt.value = p; opt.textContent = p; playerSelect.appendChild(opt);
        });
        setStatus('Choose a player');
        if(players.length){ playerSelect.value = players[0]; onPlayerChange(); }
      }catch(e){ setStatus(e.message,false); }
    }

    async function onPlayerChange(){
      const team = teamSelect.value;
      const player = playerSelect.value;
      setStatus('Loading player…');
      try{
        const data = await fetchJSON(`${API}/teams/${encodeURIComponent(team)}/players/${encodeURIComponent(player)}`);
        const phv = data.phv || {};
        const td = data.testing_data || {};
        playerSummary.innerHTML = [
          renderSummaryCard('Player', data.player),
          renderSummaryCard('Team', data.team),
          renderSummaryCard('Height (cm)', phv.Height),
          renderSummaryCard('Weight (kg)', phv.Weight),
          renderSummaryCard('Position', td['Position']),
          renderSummaryCard('Latest Test Date', td['Date'] ? new Date(td['Date']).toLocaleDateString() : '-')
        ].join('');
        testingData.innerHTML = renderTestingTable(td);

        // Build testing-based percentiles for a quick visual until GPS is wired
        await renderTestingRadars(team, player, td['Position']);
        setStatus('Loaded');
      }catch(e){ setStatus(e.message,false); }
    }

    function isLowerBetter(metric){
      const m = (metric||'').toUpperCase();
      return m.includes('SPRINT') || m.includes('AGILITY');
    }

    function percentileFor(value, arr, metric){
      const clean = arr.filter(v => v !== null && !Number.isNaN(v));
      if(!clean.length || value == null || Number.isNaN(value)) return 50;
      const better = isLowerBetter(metric)
        ? clean.filter(v => v >= value).length
        : clean.filter(v => v <= value).length;
      return Math.max(1, Math.min(99, (better / clean.length) * 100));
    }

    async function renderTestingRadars(team, player, position){
      // Fetch team roster and all testing_data
      const players = await fetchJSON(`${API}/teams/${encodeURIComponent(team)}/players`);
      const details = await Promise.all(players.map(p => fetchJSON(`${API}/teams/${encodeURIComponent(team)}/players/${encodeURIComponent(p)}`).catch(()=>({testing_data:{}}))));

      // Build a pool of numeric metrics across team with enough coverage
      const blacklist = new Set(['NAME','DATE','PARTICIPATION','POSITION','TEAM','SEASON PHASE','TRAINING PHASE','SEASON','EVENT ID']);
      const metricCounts = {};
      for(const d of details){
        const td = d.testing_data || {};
        for(const [k,v] of Object.entries(td)){
          const key = String(k||'').trim();
          if(!key) continue;
          const upper = key.toUpperCase();
          if(blacklist.has(upper)) continue;
          const num = parseFloat(v);
          if(!Number.isFinite(num)) continue;
          metricCounts[key] = (metricCounts[key]||0)+1;
        }
      }
      // Choose up to 5 best-covered metrics
      const metrics = Object.entries(metricCounts)
        .filter(([,cnt])=>cnt>=5)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,5)
        .map(([k])=>k);

      if(metrics.length === 0){
        // fallback to common ones
        ['VO2MAX','BROAD JUMP','MED BALL THROW AVG','10M SPRINT','AGILITY TEST'].forEach(m=>{ if(!metrics.includes(m)) metrics.push(m); });
      }

      const teamVals = Object.fromEntries(metrics.map(m => [m, details.map(d => parseFloat(d.testing_data?.[m])).map(v => (isFinite(v)? v: null))]));
      const posDetails = details.filter(d => (d.testing_data?.['Position'] || '').toLowerCase() === (position || '').toLowerCase());
      const posVals = Object.fromEntries(metrics.map(m => [m, posDetails.map(d => parseFloat(d.testing_data?.[m])).map(v => (isFinite(v)? v: null))]));

      // Current player values
      const me = details.find(d => d.player === player);
      const myVals = Object.fromEntries(metrics.map(m => [m, parseFloat(me?.testing_data?.[m])]))

      const teamPerc = metrics.map(m => percentileFor(myVals[m], teamVals[m], m));
      const posPerc = metrics.map(m => percentileFor(myVals[m], posVals[m], m));

      const cfg = (labels, data, label) => ({
        type: 'radar',
        data: { labels, datasets: [{
          label,
          data,
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34,197,94,0.2)',
          pointBackgroundColor: '#22c55e'
        }]},
        options: { scales: { r: { beginAtZero: true, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' } } }, plugins:{legend:{labels:{color:'#e5e7eb'}}} }
      });

      if(chartTeam) chartTeam.destroy();
      if(chartPosition) chartPosition.destroy();
      chartTeam = new Chart(document.getElementById('radarTeam'), cfg(metrics, teamPerc, 'vs Team'));
      chartPosition = new Chart(document.getElementById('radarPosition'), cfg(metrics, posPerc, 'vs Position'));
    }

    async function init(){
      // Require login
      if(!session){
        loginOverlay.classList.remove('hidden');
        return;
      }
      setStatus('Loading teams…');
      try{
        const teams = await fetchJSON(`${API}/teams`);
        const allowed = new Set(session.teams || []);
        const visible = teams.filter(t => allowed.size === 0 || allowed.has(t));
        teamSelect.innerHTML = '';
        visible.forEach(t=>{
          const opt = document.createElement('option');
          opt.value = t; opt.textContent = t; teamSelect.appendChild(opt);
        });
        setStatus('Choose a team');
        if(visible.length){ teamSelect.value = visible[0]; await onTeamChange(); }
      }catch(e){ setStatus(e.message,false); }
    }

    teamSelect.addEventListener('change', onTeamChange);
    playerSelect.addEventListener('change', onPlayerChange);
    loginBtn.addEventListener('click', async ()=>{
      loginError.textContent = '';
      try{
        const out = await postJSON(`${API}/auth/login`, {username: loginUser.value, password: loginPass.value});
        session = out; localStorage.setItem('bolts_session', JSON.stringify(out));
        loginOverlay.classList.add('hidden');
        init();
      }catch(e){ loginError.textContent = 'Invalid credentials'; }
    });
    init();
  </script>
</body>
</html>

